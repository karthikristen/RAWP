<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üíß‚ò¢Ô∏è RAWP - Radioactive Water Predictor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0a0a0a; color: #e8f5e9; font-family: 'Bebas Neue', sans-serif; text-align:center; }
    h1 { color:#FFD300; text-shadow:0 0 10px #FFD300; }
    .tabs { display:flex; justify-content:center; margin:20px 0; }
    .tab { padding:10px 20px; cursor:pointer; background:#222; margin:0 5px; border-radius:8px; }
    .tab.active { background:#FFD300; color:#000; font-weight:bold; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .container { width:70%; margin:auto; padding:20px; }
    input, textarea { padding:8px; margin:6px; width:80%; border-radius:6px; }
    button { padding:10px 20px; margin:10px; background:#FFD300; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
    #gauge-container { width:300px; margin:auto; }
    .box { background:#111; padding:15px; border-radius:12px; margin:10px; }
  </style>
</head>
<body>
  <h1>üíß‚ò¢Ô∏è RAWP</h1>
  <p>Radioactive Water Predictor</p>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="manual">Manual Input</div>
    <div class="tab" data-tab="esp">ESP Data</div>
  </div>

  <!-- Manual Input Tab -->
  <div id="manual" class="tab-content active container">
    <form id="waterForm">
      <input type="number" step="0.1" name="ph" placeholder="pH (0‚Äì14)" required><br>
      <input type="number" step="0.1" name="tds" placeholder="TDS (mg/L, ‚â§2000)" required><br>
      <input type="number" step="0.1" name="hardness" placeholder="Hardness (mg/L, ‚â§1000)" required><br>
      <input type="number" step="0.1" name="nitrate" placeholder="Nitrate (mg/L, ‚â§500)" required><br>
      <input type="text" name="location" placeholder="Location"><br>
      <textarea name="notes" placeholder="Extra Notes..."></textarea><br>
      <button type="submit">Run Analysis</button>
    </form>
    <button id="sendReportBtn" style="display:none;">üìß Send Report via Email</button>
    <div id="result" class="box"></div>
    <div id="gauge-container"><canvas id="gauge"></canvas></div>
    <div id="barChartContainer"><canvas id="barChart"></canvas></div>
  </div>

  <!-- ESP Tab -->
  <div id="esp" class="tab-content container">
    <p>Fetching live TDS & water data from ESP...</p>
    <button id="fetchESP">üîÑ Refresh ESP Data</button>
    <div id="espResult" class="box"></div>
  </div>

  <script>
    const backend = "https://rawp.onrender.com";
    let lastReport = null;

    // Tab switching
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    // Manual Input Submit
    document.getElementById("waterForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      const res = await fetch(`${backend}/submit`, { method: "POST", body: formData });
      const data = await res.json();
      lastReport = data; // save for email

      document.getElementById("result").innerHTML = `
        <h3>${data.status}</h3>
        <p>Risk Score: ${data.risk_score}</p>
        <p><b>Detected Elements:</b> ${data.detected_elements.length ? data.detected_elements.join(", ") : "None"}</p>
        <p><b>Treatment:</b> ${data.treatments.join(", ")}</p>
        <p><b>Email Status:</b> Ready to send</p>
      `;

      document.getElementById("sendReportBtn").style.display = "inline-block";

      // Gauge
      new Chart(document.getElementById("gauge"), {
        type: 'doughnut',
        data: {
          datasets: [{ data: [data.risk_score, 100 - data.risk_score], backgroundColor: ["red","gray"] }]
        },
        options: { cutout: "80%", plugins:{legend:{display:false}} }
      });

      // Bar Chart
      new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: {
          labels: ["pH","TDS","Hardness","Nitrate"],
          datasets: [{
            label: "Your Values",
            data: [ data.scaled_inputs.ph, data.scaled_inputs.tds, data.scaled_inputs.hardness, data.scaled_inputs.nitrate ],
            backgroundColor: "orange"
          }]
        }
      });
    });

    // Send Email Report
    document.getElementById("sendReportBtn").addEventListener("click", async () => {
      if (!lastReport) return;
      const res = await fetch(`${backend}/send_report`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(lastReport)
      });
      const data = await res.json();
      alert(data.message);
    });

    // ESP Fake Data Fetch
    document.getElementById("fetchESP").addEventListener("click", async () => {
      const res = await fetch(`${backend}/esp_data`);
      const data = await res.json();
      document.getElementById("espResult").innerHTML = `
        <p>pH: ${data.ph}</p>
        <p>TDS: ${data.tds} mg/L</p>
        <p>Hardness: ${data.hardness} mg/L</p>
        <p>Nitrate: ${data.nitrate} mg/L</p>
        <p>Status: ${data.status}</p>
      `;
    });
  </script>
</body>
</html>
