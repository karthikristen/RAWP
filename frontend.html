<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RAWP Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    .tabs { display: flex; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: #ddd; cursor: pointer; margin-right: 5px; border-radius: 5px; }
    .tab.active { background: #007bff; color: white; }
    .content { display: none; }
    .content.active { display: block; }
    #gauge { width: 300px; height: 300px; }
    .btn { padding: 10px 20px; margin-top: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>

  <h1>üíß RAWP Water Dashboard</h1>
  <div class="tabs">
    <div class="tab active" onclick="showTab('dashboard')">Dashboard</div>
    <div class="tab" onclick="showTab('esp')">ESP Readings</div>
    <div class="tab" onclick="showTab('manual')">Manual Input</div>
    <div class="tab" onclick="showTab('report')">Send Report</div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="content active">
    <h2>üìä Dashboard</h2>
    <div id="gauge"></div>
    <canvas id="lineGraph" width="600" height="400"></canvas>
    <p id="status"></p>
  </div>

  <!-- ESP -->
  <div id="esp" class="content">
    <h2>üì° ESP Readings</h2>
    <button class="btn" onclick="fetchESPData()">Next Reading</button>
    <pre id="espData"></pre>
  </div>

  <!-- Manual -->
  <div id="manual" class="content">
    <h2>‚úçÔ∏è Enter Manual Data</h2>
    <form id="manualForm">
      <label>TDS: <input type="number" step="0.1" id="tds"></label><br>
      <button type="submit" class="btn">Submit</button>
    </form>
    <pre id="manualResult"></pre>
  </div>

  <!-- Report -->
  <div id="report" class="content">
    <h2>üìß Send Email Report</h2>
    <button class="btn" onclick="sendReport()">Send Report</button>
    <p id="emailStatus"></p>
  </div>

<script>
  const backend = "https://rawp.onrender.com"; // your backend URL
  let latestData = null;

  function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
  }

  // Plot gauge meter
  function updateGauge(tds) {
    let data = [{
      type: "indicator",
      mode: "gauge+number",
      value: tds,
      title: { text: "TDS (mg/L)" },
      gauge: {
        axis: { range: [0, 1000] },
        steps: [
          { range: [0, 300], color: "lightgreen" },
          { range: [300, 500], color: "yellow" },
          { range: [500, 1000], color: "red" }
        ]
      }
    }];
    Plotly.newPlot('gauge', data);
  }

  // Line Graph
  let chart = new Chart(document.getElementById('lineGraph'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: "TDS", data: [], borderColor: "blue", fill: false },
        { label: "pH", data: [], borderColor: "green", fill: false },
        { label: "Hardness", data: [], borderColor: "orange", fill: false },
        { label: "Nitrate", data: [], borderColor: "red", fill: false }
      ]
    },
    options: { responsive: true }
  });

  // Update Dashboard
  function updateDashboard(data) {
    latestData = data;
    updateGauge(data.scaled_inputs.tds);
    document.getElementById('status').innerText = "Status: " + data.status;
    chart.data.labels.push(new Date().toLocaleTimeString());
    chart.data.datasets[0].data.push(data.scaled_inputs.tds);
    chart.data.datasets[1].data.push(data.scaled_inputs.ph);
    chart.data.datasets[2].data.push(data.scaled_inputs.hardness);
    chart.data.datasets[3].data.push(data.scaled_inputs.nitrate);
    chart.update();
  }

  // Fetch ESP Data
  async function fetchESPData() {
    let res = await fetch(`${backend}/esp-data`);
    let data = await res.json();
    if (data.scaled_inputs) {
      document.getElementById("espData").innerText = JSON.stringify(data, null, 2);
      updateDashboard(data);
    } else {
      document.getElementById("espData").innerText = "No ESP data yet";
    }
  }

  // Manual Submit
  document.getElementById("manualForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    let tds = parseFloat(document.getElementById("tds").value);
    let formData = new FormData();
    formData.append("tds", tds);

    let res = await fetch(`${backend}/esp-data`, { method: "POST", body: formData });
    let data = await res.json();
    document.getElementById("manualResult").innerText = JSON.stringify(data, null, 2);
    updateDashboard(data);
  });

  // Send Report
  async function sendReport() {
    if (!latestData) {
      document.getElementById("emailStatus").innerText = "No data to send!";
      return;
    }
    let res = await fetch(`${backend}/send-report`, { method: "POST" });
    let result = await res.json();
    document.getElementById("emailStatus").innerText = result.message;
  }
</script>
</body>
</html>
