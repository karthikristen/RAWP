<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üíß‚ò¢Ô∏è RAWP - Water Quality Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0a0a0a; color: #e8f5e9; font-family: 'Bebas Neue', sans-serif; text-align:center; }
    h1 { color:#FFD300; text-shadow:0 0 10px #FFD300; }
    .container { width:70%; margin:auto; padding:20px; }
    button { padding:10px 20px; margin:10px; background:#FFD300; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
    #gauge-container { width:300px; margin:auto; }
    canvas { margin:20px auto; }
    .box { background:#111; padding:15px; border-radius:12px; margin:10px; }
  </style>
</head>
<body>
  <h1>üíß‚ò¢Ô∏è RAWP</h1>
  <p>Radioactive Water Predictor</p>
  <div class="container">
    <button id="fetchESP">üì° Get Reading from ESP</button>
    <button id="sendReport">üìß Send Report</button>

    <div id="result" class="box"></div>

    <div id="gauge-container">
      <canvas id="gauge"></canvas>
    </div>

    <div id="barChartContainer">
      <canvas id="barChart"></canvas>
    </div>
  </div>

  <script>
    const backend = "https://rawp.onrender.com";  // your Render backend
    const esp = "http://192.168.4.1";             // change to your ESP IP

    let lastData = null; // store last reading for sending report

    // === Convert TDS -> Other Params (mock scientific scaling) ===
    function generateParams(tds) {
      let ph = 6.5 + (tds % 200) / 400;          // pH drifts slightly with TDS
      let hardness = Math.min(1000, tds * 2);    // hardness grows with TDS
      let nitrate = Math.min(500, tds / 4);      // nitrate approx 1/4th of TDS
      return { ph, hardness, nitrate };
    }

    // === Fetch from ESP ===
    document.getElementById("fetchESP").addEventListener("click", async () => {
      try {
        let res = await fetch(`${esp}/tds`);
        let espData = await res.json();
        let tds = espData.tds;

        let params = generateParams(tds);

        // prepare FormData for backend
        let formData = new FormData();
        formData.append("ph", params.ph);
        formData.append("tds", tds);
        formData.append("hardness", params.hardness);
        formData.append("nitrate", params.nitrate);
        formData.append("location", "ESP8266");
        formData.append("notes", "Live ESP Reading");

        let backendRes = await fetch(`${backend}/submit`, {
          method: "POST",
          body: formData
        });

        let data = await backendRes.json();
        lastData = data; // save for sending report

        displayResults(data);
      } catch (err) {
        document.getElementById("result").innerHTML = `<p style="color:red;">‚ö†Ô∏è ESP not reachable</p>`;
      }
    });

  // === Send Report (call /report backend) ===
document.getElementById("sendReport").addEventListener("click", async () => {
  try {
    let res = await fetch(`${backend}/report`, { method: "POST" });
    let data = await res.json();
    alert(data.message);
  } catch (err) {
    alert("‚ùå Failed to send report");
  }
});

    // === Display results in dashboard ===
    function displayResults(data) {
      document.getElementById("result").innerHTML = `
        <h3>${data.status}</h3>
        <p>Risk Score: ${data.risk_score}</p>
        <p><b>Detected Elements:</b> ${data.detected_elements.length ? data.detected_elements.join(", ") : "None"}</p>
        <p><b>Treatment:</b> ${data.treatments.join(", ")}</p>
        <p><b>Email Status:</b> ${data.email_status.message}</p>
      `;

      // Gauge meter
      new Chart(document.getElementById("gauge"), {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [data.risk_score, 100 - data.risk_score],
            backgroundColor: ["red","gray"]
          }]
        },
        options: { cutout: "80%", plugins:{legend:{display:false}} }
      });

      // Bar chart
      new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: {
          labels: ["pH","TDS","Hardness","Nitrate"],
          datasets: [{
            label: "Your Values",
            data: [
              data.scaled_inputs.ph,
              data.scaled_inputs.tds,
              data.scaled_inputs.hardness,
              data.scaled_inputs.nitrate
            ],
            backgroundColor: "orange"
          }]
        }
      });
    }
  </script>
</body>
</html>
