<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üíß‚ò¢Ô∏è RAWP - Radioactive Water Predicter</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0a0a0a; color: #e8f5e9; font-family: 'Bebas Neue', sans-serif; text-align:center; }
    h1 { color:#FFD300; text-shadow:0 0 10px #FFD300; }
    .tabs { display:flex; justify-content:center; margin:20px; }
    .tab { padding:10px 20px; background:#111; margin:5px; border-radius:8px; cursor:pointer; }
    .tab.active { background:#FFD300; color:#000; }
    .tab-content { display:none; margin-top:20px; }
    .tab-content.active { display:block; }
    input, textarea { padding:8px; margin:6px; width:80%; border-radius:6px; }
    button { padding:10px 20px; margin:10px; background:#FFD300; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
    #gauge-container { width:300px; margin:auto; }
    canvas { margin:20px auto; }
    .box { background:#111; padding:15px; border-radius:12px; margin:10px; }
  </style>
</head>
<body>
  <h1>üíß‚ò¢Ô∏è RAWP</h1>
  <p>Radioactive Water Predicter</p>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('espTab')">üì° ESP Live</div>
    <div class="tab" onclick="switchTab('manualTab')">‚úçÔ∏è Manual Input</div>
    <div class="tab" onclick="switchTab('reportTab')">üìß Reports</div>
  </div>

  <!-- ESP Tab -->
  <div id="espTab" class="tab-content active">
    <h2>ESP Live Data</h2>
    <form id="espForm">
      <input type="number" step="0.1" name="tds" placeholder="TDS from ESP (mg/L)" required><br>
      <button type="submit">Fetch Analysis</button>
    </form>
    <div id="espResult" class="box"></div>
  </div>

  <!-- Manual Input Tab -->
  <div id="manualTab" class="tab-content">
    <h2>Manual Data Entry</h2>
    <form id="manualForm">
      <input type="number" step="0.1" name="ph" placeholder="pH" required><br>
      <input type="number" step="0.1" name="tds" placeholder="TDS (mg/L)" required><br>
      <input type="number" step="0.1" name="hardness" placeholder="Hardness (mg/L)" required><br>
      <input type="number" step="0.1" name="nitrate" placeholder="Nitrate (mg/L)" required><br>
      <input type="text" name="location" placeholder="Location"><br>
      <textarea name="notes" placeholder="Extra Notes..."></textarea><br>
      <button type="submit">Run Analysis</button>
    </form>
    <div id="manualResult" class="box"></div>
  </div>

  <!-- Report Tab -->
  <div id="reportTab" class="tab-content">
    <h2>Send Report</h2>
    <button onclick="sendReport()">üìß Send Last Report via Email</button>
    <div id="reportStatus" class="box"></div>
  </div>

  <!-- Charts -->
  <div id="gauge-container">
    <canvas id="gauge"></canvas>
  </div>
  <div>
    <canvas id="barChart"></canvas>
  </div>

  <script>
    const backend = "https://rawp.onrender.com";
    let lastReport = null;

    function switchTab(tabId) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(tc => tc.classList.remove("active"));
      document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add("active");
      document.getElementById(tabId).classList.add("active");
    }

    // ESP Form
    document.getElementById("espForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const res = await fetch(`${backend}/esp`, { method: "POST", body: formData });
      const data = await res.json();
      lastReport = data;
      showResult("espResult", data);
      drawCharts(data);
    });

    // Manual Form
    document.getElementById("manualForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const res = await fetch(`${backend}/submit`, { method: "POST", body: formData });
      const data = await res.json();
      lastReport = data;
      showResult("manualResult", data);
      drawCharts(data);
    });

    // Show result
    function showResult(divId, data) {
      document.getElementById(divId).innerHTML = `
        <h3>${data.status}</h3>
        <p>Risk Score: ${data.risk_score}</p>
        <p><b>Detected Elements:</b> ${data.detected_elements?.length ? data.detected_elements.join(", ") : "None"}</p>
        <p><b>Treatment:</b> ${data.treatments?.join(", ")}</p>
      `;
    }

    // Charts
    let gaugeChart, barChart;
    function drawCharts(data) {
      const ctxGauge = document.getElementById("gauge").getContext("2d");
      if (gaugeChart) gaugeChart.destroy();
      gaugeChart = new Chart(ctxGauge, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [data.risk_score, 100 - data.risk_score],
            backgroundColor: ["red", "gray"]
          }]
        },
        options: { cutout: "80%", plugins:{legend:{display:false}} }
      });

      const ctxBar = document.getElementById("barChart").getContext("2d");
      if (barChart) barChart.destroy();
      barChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
          labels: ["pH","TDS","Hardness","Nitrate"],
          datasets: [{
            label: "Your Values",
            data: [
              data.scaled_inputs.ph,
              data.scaled_inputs.tds,
              data.scaled_inputs.hardness,
              data.scaled_inputs.nitrate
            ],
            backgroundColor: "orange"
          }]
        }
      });
    }

    // Send report email
    async function sendReport() {
      if (!lastReport) {
        document.getElementById("reportStatus").innerText = "‚ùå No report available yet.";
        return;
      }
      const res = await fetch(`${backend}/submit`, {
        method: "POST",
        body: new URLSearchParams({
          ph: lastReport.scaled_inputs.ph,
          tds: lastReport.scaled_inputs.tds,
          hardness: lastReport.scaled_inputs.hardness,
          nitrate: lastReport.scaled_inputs.nitrate,
          location: "ESP/Manual Report",
          notes: "Auto-sent from frontend"
        })
      });
      const data = await res.json();
      document.getElementById("reportStatus").innerText = data.email_status.message;
    }
  </script>
</body>
</html>
